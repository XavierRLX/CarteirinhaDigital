<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Usuários</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container-fluid py-4">
    <div class="row g-4">
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <h1 class="h5 mb-3">Cadastro / Edição de Usuário</h1>
            <p class="text-muted small mb-3">
              Apenas administradores podem acessar esta tela.
            </p>

            <form
              id="registerForm"
              enctype="multipart/form-data"
              novalidate
            >
              <input type="hidden" id="userId" name="userId" />

              <div class="mb-2">
                <label for="nome" class="form-label">Nome Completo</label>
                <input type="text" id="nome" name="nome" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="nomePerfil" class="form-label">Nome Perfil</label>
                <input type="text" id="nomePerfil" name="nomePerfil" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" name="email" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="password" class="form-label">Senha</label>
                <input type="password" id="password" name="password" class="form-control" />
                <div class="form-text">
                  Em edição, deixe em branco para manter a senha atual.
                </div>
              </div>

              <div class="mb-2">
                <label for="curso" class="form-label">Curso</label>
                <input type="text" id="curso" name="curso" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="campus" class="form-label">Campus</label>
                <input type="text" id="campus" name="campus" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="matricula" class="form-label">Matrícula</label>
                <input type="text" id="matricula" name="matricula" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="cpf" class="form-label">CPF</label>
                <input type="text" id="cpf" name="cpf" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="numeroTel" class="form-label">Telefone</label>
                <input type="tel" id="numeroTel" name="numeroTel" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                <input type="date" id="dataNascimento" name="dataNascimento" class="form-control" required />
              </div>

              <div class="mb-2">
                <label for="validade" class="form-label">Validade da Carteirinha</label>
                <input type="date" id="validade" name="validade" class="form-control" required />
              </div>

              <div class="mb-3">
                <label for="foto" class="form-label">Foto</label>
                <input
                  type="file"
                  id="foto"
                  name="foto"
                  class="form-control"
                  accept="image/*"
                />
                <div class="form-text">
                  Em edição, selecione uma nova imagem caso queira trocar a foto.
                </div>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" id="submitBtn" class="btn btn-primary flex-grow-1">
                  Registrar
                </button>
                <button
                  type="button"
                  id="cancelEditBtn"
                  class="btn btn-outline-secondary"
                  style="display: none;"
                >
                  Cancelar
                </button>
              </div>
            </form>

            <hr class="my-3" />

            <a href="/login" class="small">Voltar para login</a>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Lista de Usuários</h2>
              <span class="badge bg-secondary" id="userCountBadge"></span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Telefone</th>
                    <th>Validade</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="userList">
                  <!-- preenchido via JS -->
                </tbody>
              </table>
            </div>
            <p class="text-muted small mb-0">
              Use os botões para ativar, inativar, editar ou excluir usuários.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/javaScript/ui.js"></script>

  <script>
    const ADMIN_PASSWORD = 'RumoaoDima24@'; 

    let usersCache = [];
    let editingUserId = null;

    function solicitarSenhaAdmin() {
      const inputPassword = prompt('Por favor, insira a senha de administrador:');
      if (inputPassword !== ADMIN_PASSWORD) {
        showAlert('Senha de administrador incorreta!', 'error');
        window.location.href = '/login';
        return false;
      }
      return true;
    }

    async function loadUsers() {
      const tbody = document.getElementById('userList');
      const badge = document.getElementById('userCountBadge');

      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted py-3">
            Carregando usuários...
          </td>
        </tr>
      `;

      try {
        const response = await fetch('/api/admin/users', {
          method: 'GET',
          headers: {
            'x-admin-password': ADMIN_PASSWORD,
          },
        });

        const data = await response.json();

        if (!response.ok) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger py-3">
                Erro ao carregar usuários: ${data.error || 'Erro desconhecido'}
              </td>
            </tr>
          `;
          return;
        }

        usersCache = Array.isArray(data) ? data : [];
        badge.textContent = usersCache.length + ' usuário(s)';

        if (usersCache.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted py-3">
                Nenhum usuário cadastrado.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = '';

        usersCache.forEach((user) => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${user.nome || ''}</td>
            <td>${user.email || ''}</td>
            <td>
              <span class="badge bg-${user.status === 'active' ? 'success' : (user.status === 'pending' ? 'warning' : 'secondary')}">
                ${user.status}
              </span>
            </td>
            <td>${user.numero_tel || ''}</td>
            <td>${user.validade || ''}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="editUser('${user.id}')">Editar</button>
                <button type="button" class="btn btn-outline-success" onclick="changeStatus('${user.id}', 'active')">Ativar</button>
                <button type="button" class="btn btn-outline-warning" onclick="changeStatus('${user.id}', 'inactive')">Inativar</button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteUser('${user.id}')">Excluir</button>
              </div>
            </td>
          `;

          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger py-3">
              Erro ao carregar usuários.
            </td>
          </tr>
        `;
      }
    }

    function preencherFormComUsuario(user) {
      const form = document.getElementById('registerForm');

      form.userId.value = user.id;
      form.nome.value = user.nome || '';
      form.nomePerfil.value = user.nome_perfil || '';
      form.email.value = user.email || '';
      form.curso.value = user.curso || '';
      form.campus.value = user.campus || '';
      form.matricula.value = user.matricula || '';
      form.cpf.value = user.cpf || '';
      form.numeroTel.value = user.numero_tel || '';
      form.dataNascimento.value = user.data_nascimento || '';
      form.validade.value = user.validade || '';
      form.password.value = '';
      if (form.foto) form.foto.value = '';
    }

    function resetForm() {
      const form = document.getElementById('registerForm');
      form.reset();
      form.userId.value = '';
      if (form.foto) form.foto.value = '';
      editingUserId = null;

      document.getElementById('submitBtn').textContent = 'Registrar';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    async function handleRegisterSubmit(event) {
      event.preventDefault();

      const form = event.target;
      const isEditing = !!editingUserId;
      const fotoInput = form.foto;

      const formData = new FormData();

      formData.append('nome', form.nome.value.trim());
      formData.append('nomePerfil', form.nomePerfil.value.trim());
      formData.append('email', form.email.value.trim());
      formData.append('curso', form.curso.value.trim());
      formData.append('campus', form.campus.value.trim());
      formData.append('matricula', form.matricula.value.trim());
      formData.append('cpf', form.cpf.value.trim());
      formData.append('numeroTel', form.numeroTel.value.trim());
      formData.append('dataNascimento', form.dataNascimento.value);
      formData.append('validade', form.validade.value);

      if (!isEditing) {
        if (!form.password.value) {
          showAlert('Senha é obrigatória para novo usuário.', 'warning');
          return;
        }
        formData.append('password', form.password.value);
      } else if (form.password.value) {
        formData.append('password', form.password.value);
      }

      if (!isEditing && (!fotoInput.files || !fotoInput.files[0])) {
        showAlert('Selecione uma foto para o usuário.', 'warning');
        return;
      }

      if (fotoInput.files && fotoInput.files[0]) {
        formData.append('foto', fotoInput.files[0]);
      }

      try {
        const url = isEditing
          ? `/api/admin/users/${editingUserId}`
          : '/api/admin/users';
        const method = isEditing ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'x-admin-password': ADMIN_PASSWORD,
          },
          body: formData,
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          showAlert(data.error || 'Erro ao salvar usuário.', 'error');
          return;
        }

        showAlert(
          isEditing ? 'Usuário atualizado com sucesso!' : 'Usuário cadastrado com sucesso!',
          'success'
        );

        resetForm();
        loadUsers();
      } catch (error) {
        console.error('Erro ao salvar usuário:', error);
        showAlert('Erro ao salvar usuário. Tente novamente.', 'error');
      }
    }

    // Funções globais usadas pelos botões da tabela
    window.editUser = function (id) {
      const user = usersCache.find((u) => u.id === id);
      if (!user) {
        showAlert('Usuário não encontrado.', 'error');
        return;
      }

      editingUserId = id;
      preencherFormComUsuario(user);

      document.getElementById('submitBtn').textContent = 'Salvar alterações';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
    };

    window.changeStatus = async function (id, newStatus) {
      if (!confirm(`Deseja realmente alterar o status para "${newStatus}"?`)) return;

      try {
        const response = await fetch(`/api/admin/users/${id}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-password': ADMIN_PASSWORD,
          },
          body: JSON.stringify({ status: newStatus }),
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          showAlert(data.error || 'Erro ao alterar status.', 'error');
          return;
        }

        showAlert('Status atualizado com sucesso!', 'success');
        loadUsers();
      } catch (error) {
        console.error('Erro ao alterar status:', error);
        showAlert('Erro ao alterar status.', 'error');
      }
    };

    window.deleteUser = async function (id) {
      if (!confirm('Tem certeza que deseja excluir este usuário?')) return;

      try {
        const response = await fetch(`/api/admin/users/${id}`, {
          method: 'DELETE',
          headers: {
            'x-admin-password': ADMIN_PASSWORD,
          },
        });

        if (!response.ok && response.status !== 204) {
          const data = await response.json().catch(() => ({}));
          showAlert(data.error || 'Erro ao excluir usuário.', 'error');
          return;
        }

        showAlert('Usuário excluído com sucesso.', 'success');
        loadUsers();
      } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        showAlert('Erro ao excluir usuário.', 'error');
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      if (!solicitarSenhaAdmin()) return;

      loadUsers();

      const registerForm = document.getElementById('registerForm');
      registerForm.addEventListener('submit', handleRegisterSubmit);

      document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
    });
  </script>
</body>
</html>
