<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style/styleCU.css">
    <title>Document</title>
</head>
<body>
    <h1>Cadastrar Usuário</h1>
    <form id="registerForm">
        <label for="nome">Nome Completo:</label>
        <input type="text" id="nome" name="nome" required>
        <br>
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" required>
        <br>
        <label for="nomePerfil">Nome Perfil:</label>
        <input type="text" id="nomePerfil" name="nomePerfil" required>
        <br>
        <label for="password">Senha:</label>
        <input type="password" id="password" name="password" required>
        <br>
        <label for="curso">Curso:</label>
        <input type="text" id="curso" name="curso" required>
        <br>
        <label for="matricula">Matrícula</label>
        <input type="text" id="matricula" name="matricula" required>
        <br>
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" name="cpf" required>
        <br>
        <label for="dataNascimento">Data de nascimento:</label>
        <input type="date" id="dataNascimento" name="dataNascimento" required>
        <br>
        <label for="numeroTel">Número de Telefone:</label>
        <input type="tel" id="numeroTel" name="numeroTel" required>
        <br>
        <label for="campus">Campus:</label>
        <input type="text" id="campus" name="campus" required>
        <br>
        <label for="validade">Validade:</label>
        <input type="date" id="validade" name="validade" required>
        <br>
        <label for="fotoUrl">URL da Foto:</label>
        <input type="text" id="fotoUrl" name="fotoUrl" required>
        <br>
        <button type="submit">Registrar</button>
    </form>

    <a href="/login" title="Ir para Login">Login</a>

    <h2>Lista de Usuários</h2>
    <div id="userList"></div>

    <script>
        const supabaseUrl = 'https://mjjumtkxcqbdbynzmqqh.supabase.co';
        const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qanVtdGt4Y3FiZGJ5bnptcXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTg3MTA3NTIsImV4cCI6MjAzNDI4Njc1Mn0.1Bfat4NXHJjTFZf-RV6fFUNr56kVqjwetH4ROWBDEuE';
        const adminPassword = 'admin1234';
        let enteredPassword = '';

        function checkAdminPassword() {
            const inputPassword = prompt("Por favor, insira a senha de administrador:");
            if (inputPassword !== adminPassword) {
                alert('Senha de administrador incorreta!');
                return false;
            }
            enteredPassword = inputPassword;
            return true;
        }

        document.getElementById('registerForm').addEventListener('submit', async (event) => {
            event.preventDefault();

           const inputPassword = prompt("Por favor, insira a senha de administrador:");
            
            if (inputPassword !== 'cadastrarAdmin1234') {
                alert('Senha de administrador incorreta!');
                return;
            }

            const email = event.target.email.value;
            const password = event.target.password.value;
            const nome = event.target.nome.value;
            const nomePerfil = event.target.nomePerfil.value;
            const curso = event.target.curso.value;
            const campus = event.target.campus.value;
            const matricula = event.target.matricula.value;
            const cpf = event.target.cpf.value;
            const numeroTel = event.target.numeroTel.value;
            const dataNascimento = event.target.dataNascimento.value;
            const validade = event.target.validade.value;
            const fotoUrl = event.target.fotoUrl.value;

            const url = `${supabaseUrl}/rest/v1/users`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': apiKey,
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({ email, password, nome, nomePerfil, campus, curso, matricula, validade, cpf, dataNascimento, numeroTel, fotoUrl }),
            
            });

            if (response.ok) {
                alert('Usuário cadastrado com sucesso!');
                loadUsers(); // Carregar a lista de usuários após o cadastro
            } else {
                const data = await response.json();
                alert('Erro: ' + data.error);
            }
        });

        // Função para carregar a lista de usuários
        async function loadUsers() {
            const url = `${supabaseUrl}/rest/v1/users?select=*`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': apiKey,
                    'Authorization': `Bearer ${apiKey}`
                },
            });

            if (response.ok) {
                const data = await response.json();
                const userList = document.getElementById('userList');
                userList.innerHTML = ''; // Limpar a lista de usuários
                data.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.innerHTML = `
                        <p><strong>Nome:</strong> ${user.nome}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Número de Telefone:</strong> ${user.numeroTel}</p>
                        <p><strong>Validade:</strong> ${user.validade}</p>
                        <img src="${user.fotoUrl}" alt="Foto do Usuário" style="max-width: 50px;">
                        <button onclick="deleteUser('${user.id}')">Excluir</button>
                        <hr>
                    `;
                    userList.appendChild(userItem);
                });
            } else {
                alert('Erro ao carregar a lista de usuários');
            }
        }

        // Função para excluir um usuário
        async function deleteUser(id) {


            const inputPassword = prompt("Por favor, insira a senha de administrador:");
            
            if (inputPassword !== 'excluirAdmin1234') {
                alert('Senha de administrador incorreta!');
                return;
            }


            const url = `${supabaseUrl}/rest/v1/users?id=eq.${id}`;
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': apiKey,
                    'Authorization': `Bearer ${apiKey}`
                },
            });

            if (response.ok) {
                alert('Usuário excluído com sucesso!');
                loadUsers(); // Carregar a lista de usuários após a exclusão
            } else {
                alert('Erro ao excluir o usuário');
            }
        }

        //Carregar a lista de usuários quando a página for carregada
        window.onload = () => {
            if (checkAdminPassword()) {
                loadUsers();
            }
        };
    </script>
</body>
</html>