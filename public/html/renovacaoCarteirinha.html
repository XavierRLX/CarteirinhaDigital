<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Renovação da Carteirinha</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <h1 class="h5 mb-3 text-center">Renovação da Carteirinha</h1>
            <p class="text-muted small mb-2 text-center">
              Sua carteirinha está expirada. Para continuar utilizando o acesso digital, é necessário renová-la.
            </p>
            <p class="text-muted small mb-2 text-center">
              <strong>Taxa de renovação:</strong> R$ 20,00 (valor válido para o período atual da carteirinha).
            </p>
            <p class="text-muted small mb-4 text-center">
              <strong>Prazo de retorno:</strong> o pedido é analisado em até <strong>24h a 48h úteis</strong> após o envio.
            </p>
            <p class="text-muted small mb-4 text-center">
              <strong>Chave Pix</strong> o pedido é analisado em até <strong>24h a 48h úteis</strong> após o envio.
            </p>

            <div class="mb-3">
              <p class="mb-1"><strong>Usuário:</strong> <span id="nomeUsuario"></span></p>
              <p class="mb-1"><strong>Email:</strong> <span id="emailUsuario"></span></p>
              <p class="mb-0"><strong>Validade atual:</strong> <span id="validadeAtual"></span></p>
            </div>

            <form id="renewForm" enctype="multipart/form-data" novalidate>
              <div class="mb-3">
                <label for="comprovante" class="form-label">Comprovante de pagamento</label>
                <input
                  type="file"
                  id="comprovante"
                  name="comprovante"
                  class="form-control"
                  accept="image/*"
                  required
                />
                <div class="form-text">
                  Envie uma foto nítida do comprovante de pagamento no valor de
                  <strong>R$ 20,00</strong> (JPEG, PNG, etc).
                </div>
              </div>

              <div class="mb-3">
                <label for="mensagem" class="form-label">Observações (opcional)</label>
                <textarea
                  id="mensagem"
                  name="mensagem"
                  class="form-control"
                  rows="3"
                  placeholder="Ex: Comprovante referente ao semestre 2025.1 ou alguma observação para a secretaria."
                ></textarea>
              </div>

              <button type="submit" class="btn btn-primary w-100">
                Enviar pedido de renovação
              </button>
            </form>

            <hr class="my-4" />

            <div class="d-flex justify-content-between">
              <a href="/carteirinhaDigital" class="small">Voltar para carteirinha</a>
              <a href="/login" class="small">Sair</a>
            </div>
          </div>
        </div>

        <p class="text-center text-muted small mt-3 mb-1">
          Seu pedido será analisado por um administrador. A carteirinha será liberada após a confirmação do pagamento.
        </p>
        <p class="text-center text-muted small mb-1">
          <strong>Ajude a manter o nosso site online:</strong> a taxa de renovação contribui para a manutenção e continuidade deste projeto acadêmico.
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/javaScript/ui.js"></script>

  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', () => {
      const stored = localStorage.getItem('userInfo');
      if (!stored) {
        showAlert('Você precisa fazer login novamente.', 'warning');
        window.location.href = '/login';
        return;
      }

      try {
        currentUser = JSON.parse(stored);
      } catch (e) {
        showAlert('Erro ao carregar dados do usuário.', 'error');
        window.location.href = '/login';
        return;
      }

      document.getElementById('nomeUsuario').textContent =
        currentUser.nome || currentUser.nomePerfil || '';
      document.getElementById('emailUsuario').textContent = currentUser.email || '';
      document.getElementById('validadeAtual').textContent = currentUser.validade || '';

      const form = document.getElementById('renewForm');
      form.addEventListener('submit', handleRenewSubmit);
    });

    async function handleRenewSubmit(event) {
      event.preventDefault();

      const form = event.target;
      const fileInput = form.comprovante;
      const file = fileInput.files[0];

      if (!file) {
        showAlert('Selecione um comprovante.', 'warning');
        return;
      }

      if (!file.type.startsWith('image/')) {
        showAlert('Envie uma imagem (jpeg, png, etc).', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('userId', currentUser.id);
      formData.append('comprovante', file);
      formData.append('mensagem', form.mensagem.value.trim());

      try {
        const response = await fetch('/api/renewals', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          showAlert(data.error || 'Erro ao enviar pedido de renovação.', 'error');
          return;
        }

        showAlert('Pedido de renovação enviado com sucesso! Aguarde aprovação.', 'success');
        form.reset();

        setTimeout(() => {
          window.location.href = '/carteirinhaDigital';
        }, 1500);
      } catch (error) {
        console.error('Erro ao enviar pedido de renovação:', error);
        showAlert('Erro ao enviar pedido. Tente novamente.', 'error');
      }
    }
  </script>
</body>
</html>
